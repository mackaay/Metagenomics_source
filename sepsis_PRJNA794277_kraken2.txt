#!/bin/bash
#SBATCH --time=73:59:00
#SBATCH --mem=70gb
#SBATCH --ntasks-per-node=5
#SBATCH --cpus-per-task=5     
#SBATCH --account=OD-228970

module load fastqc/0.11.9
module load trimgalore/0.6.6
module load samtools/1.12
module load picard/2.25.5
module load python/3.9.4
module load star/2.7.9a
module load subread/2.0.3

module load kraken2/2.1.3
module load bracken/2.9

KRAKEN_DB=/datasets/work/hb-diab-cfdna/work/Data/annotation/kraken2_db

cd ${SLURM_SUBMIT_DIR}

#mkdir kraken2
cd ./kraken2
#cat ../list_GSM_1 | while read id  ; do STAR --runMode alignReads --runThreadN 24 --genomeDir  /datasets/work/lw-project-airway/work/Data/genome_ref/STAR_index/h1n1 --readFilesCommand zcat --readFilesIn ../trim_GSM/${id}_1_val_1.fq.gz  ../trim_GSM/${id}_1_val_1.fq.gz --outSAMtype BAM SortedByCoordinate --outFileNamePrefix ${id} ; done       


#cat ../list | while read id  ; do kraken2 --db $KRAKEN_DB \
#        --paired ../alignment_hg38/${id}Unmapped.out.mate1 ../alignment_hg38/${id}Unmapped.out.mate2 \
#        --report ${id}_unmapped.report.txt \
#        --output ${id}_unmapped.kraken.txt \
#		--confidence 0.1 \
#        --threads 24  ; done

bracken-build -d $KRAKEN_DB -t 24 -k 35 -l 100
cat ../list | while read id  ; do bracken -d $KRAKEN_DB -i ${id}_unmapped.report.txt -o ${id}_unmapped.bracken_S.txt -r 100 -l S ; done
cat ../list | while read id  ; do bracken -d $KRAKEN_DB -i ${id}_unmapped.report.txt -o ${id}_unmapped.bracken_S1.txt -r 100 -l S1 ; done
cat ../list | while read id  ; do bracken -d $KRAKEN_DB -i ${id}_unmapped.report.txt -o ${id}_unmapped.bracken_G.txt -r 100 -l G ; done
cat ../list | while read id  ; do bracken -d $KRAKEN_DB -i ${id}_unmapped.report.txt -o ${id}_unmapped.bracken_F.txt -r 100 -l F ; done
cat ../list | while read id  ; do bracken -d $KRAKEN_DB -i ${id}_unmapped.report.txt -o ${id}_unmapped.bracken_D.txt -r 100 -l D ; done


#cat ../list_GSM_1 | while read id  ; do head -n 4000 ${id}_unmapped.report.txt > ${id}_unmapped.report.tsv ; done

